name: dependabot

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  get_current_info:
    runs-on: ubuntu-latest
    outputs:
      pkg_source_version: ${{ steps.info.outputs.pkg_source_version }}
      pkg_mirror_hash: ${{ steps.info.outputs.pkg_mirror_hash }}
    steps:
      - id: checkout
        name: checkout
        uses: actions/checkout@v4
        with:
          repository: mglants/nikkix
          ref: main
          path: nikkix
      - id: info
        name: info
        run: |
          echo "pkg_source_version=$(grep "PKG_SOURCE_VERSION:=" nikkix/nikkix/Makefile | cut -d '=' -f 2)" >> $GITHUB_OUTPUT
          echo "pkg_mirror_hash=$(grep "PKG_MIRROR_HASH:=" nikkix/nikkix/Makefile | cut -d '=' -f 2)" >> $GITHUB_OUTPUT
  get_latest_info:
    runs-on: ubuntu-latest
    outputs:
      pkg_target_version: ${{ steps.info.outputs.pkg_target_version }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/mihomo
          fetch-depth: 0
          path: mihomo

      - id: info
        shell: bash
        run: |
          set -euo pipefail

          git -C mihomo fetch --tags --force

          # Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ semver-Ñ‚ÐµÐ³
          latest_tag="$(
            git -C mihomo tag -l 'v[0-9]*' | sort -V | tail -n 1
          )"

          echo "pkg_target_version=$latest_tag" >> "$GITHUB_OUTPUT"


  update:
    needs:
      - get_current_info
      - get_latest_info
    if: ${{ needs.get_current_info.outputs.pkg_source_version != needs.get_latest_info.outputs.pkg_target_version }}
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: checkout
        uses: actions/checkout@v4
        with:
          repository: mglants/nikkix
          ref: main
          path: nikkix
      - id: update
        name: update
        run: |
          sed -i "s/PKG_RELEASE:=.*/PKG_RELEASE:=1/" nikkix/nikkix/Makefile
          sed -i "s/PKG_SOURCE_VERSION:=.*/PKG_SOURCE_VERSION:=${{ needs.get_latest_info.outputs.pkg_target_version }}/" nikkix/nikkix/Makefile
          sed -i "s/PKG_MIRROR_HASH:=.*/PKG_MIRROR_HASH:=${{ needs.get_latest_info.outputs.checksum }}/" nikkix/nikkix/Makefile
      - name: Calculate PKG_MIRROR_HASH
        id: hash_cals
        shell: bash
        env:
          MAKEFILE: nikkix/nikkix/Makefile
        run: |
          pkg_mirror_hash=$(nikkix/.ci/scripts/get_PKG_MIRROR_HASH.sh | grep '^MIRROR_HASH: ' | awk '{print $2}')
          echo "PKG_MIRROR_HASH=$pkg_mirror_hash"
          sed -i "s|^\(PKG_MIRROR_HASH\b.*\)=.*|\1=$pkg_mirror_hash|" "$MAKEFILE"
      - id: pr
        name: pr
        uses: peter-evans/create-pull-request@v6
        with:
          path: nikkix
          branch: dependabot
          commit-message: "build: bump mihomo to ${{ needs.get_latest_info.outputs.pkg_target_version }}"
          title: "build: bump mihomo to ${{ needs.get_latest_info.outputs.pkg_target_version }}"
          body: |
            Stable release update

            **mihomo:** `${{ needs.get_latest_info.outputs.pkg_target_version }}`

            ðŸ”— Changelog:
            https://github.com/MetaCubeX/mihomo/compare/${{ needs.get_current_info.outputs.pkg_source_version }}...${{ needs.get_latest_info.outputs.pkg_target_version }}
